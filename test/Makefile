VHDLDIR = ../resources/vhdl
VLOGDIR = ../resources/verilog
CONSDIR = ../resources/constraints

ICE40   = hx1k-tq144
ECP5    = 25k-CSFBGA285

test: all syn imp bit

#
# Synthesis test cases
#

syn: vhdl-simple vhdl-complex vlog-simple vlog-complex syn-ice40 syn-ecp5

vhdl-simple:
	symbiflow syn --oci-engine docker \
		--vhdl $(VHDLDIR)/blink.vhdl \
		--top Blink -o build-$@ $@

vhdl-complex:
	symbiflow syn --oci-engine docker \
		--vhdl \
			$(VHDLDIR)/blink.vhdl,blink_lib \
			$(VHDLDIR)/blink_pkg.vhdl,blink_lib \
			$(VHDLDIR)/top.vhdl \
		--top Top -o build-$@ $@

vlog-simple:
	symbiflow syn --oci-engine docker \
		--vlog $(VLOGDIR)/blink.v \
		--top Blink -o build-$@ $@

vlog-complex:
	symbiflow syn --oci-engine docker \
		--vlog \
			$(VLOGDIR)/blink.v \
			$(VLOGDIR)/top.v \
		--top Top -o build-$@ $@

syn-ice40:
	symbiflow syn --oci-engine docker \
		--vlog $(VLOGDIR)/blink.v \
		--part $(ICE40) \
		--top Blink -o build-ice40 ice40

syn-ecp5:
	symbiflow syn --oci-engine docker \
		--vlog $(VLOGDIR)/blink.v \
		--part $(ECP5) \
		--top Blink -o build-ecp5 ecp5

#
# Implementation test cases
#

imp: imp-ice40 imp-ecp5

imp-ice40:
	symbiflow imp --oci-engine docker \
		--icf $(CONSDIR)/icestick/clk.pcf $(CONSDIR)/icestick/led.pcf \
		--part $(ICE40) -o build-ice40 ice40

imp-ecp5:
	symbiflow imp --oci-engine docker --part $(ECP5) -o build-ecp5 ecp5

#
# Bitstream generation test cases
#

bit: bit-ice40 bit-ecp5

bit-ice40:
	symbiflow bit --oci-engine docker --part $(ICE40) -o build-ice40 ice40

bit-ecp5:
	symbiflow bit --oci-engine docker --part $(ECP5) -o build-ecp5 ecp5

#
# Programation
#

pgm-ice40:
	symbiflow pgm --oci-engine docker --part $(ICE40) -o build-ice40 ice40

pgm-ecp5:
	symbiflow pgm --oci-engine docker --part $(ECP5) -o build-ecp5 ecp5

#
# Complete flow test cases
#

all:

all-ice40:
	symbiflow all --oci-engine docker --part $(ICE40) \
		--vlog $(VLOGDIR)/blink.v \
		--icf $(CONSDIR)/icestick/clk.pcf $(CONSDIR)/icestick/led.pcf \
		--top Blink -o build-ice40 ice40

#
# Clean
#

clean:
	@rm -fr build-*
